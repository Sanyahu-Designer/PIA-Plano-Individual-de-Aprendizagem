{% extends "admin/base_material.html" %}
{% load i18n static %}

{% block title %}Dashboard | {{ site_title|default:_('PIA') }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Estatísticas Principais -->
  <div class="row">
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-primary-pastel shadow-primary-pastel text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">person</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Total de Alunos</p>
            <h4 class="mb-0">{{ total_alunos|default:"0" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2">
          <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+{{ novos_alunos_mes|default:"0" }} </span>novos este mês</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-success-pastel shadow-success-pastel text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">psychology</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Neurodivergências</p>
            <h4 class="mb-0">{{ total_neurodivergencias|default:"0" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2">
          <p class="mb-0">Tipos diferentes registrados</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-info-pastel shadow-info-pastel text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">search</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Em Investigação</p>
            <h4 class="mb-0">{{ total_alunos_investigacao|default:"0" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2">
          <p class="mb-0">Neurodivergência ausente</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6">
      <div class="card">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-dark-pastel shadow-dark-pastel text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">school</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Total de Profissionais</p>
            <h4 class="mb-0">{{ total_profissionais|default:"0" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2">
          <p class="mb-0"><span class="text-success text-sm font-weight-bolder">{{ profissionais_saude|default:"0" }}</span> da Saúde | <span class="text-info text-sm font-weight-bolder">{{ profissionais_educacao|default:"0" }}</span> da Educação</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos e Tabelas -->
  <div class="row mt-5">
    <!-- Distribuição por Gênero e Idade -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-primary-pastel shadow-primary-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Distribuição por Gênero</h6>
          </div>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="gender-chart" class="chart-canvas" height="170"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            <span class="text-success text-sm font-weight-bolder">{{ percentual_masculino|default:"0" }}%</span> masculino | 
            <span class="text-info text-sm font-weight-bolder">{{ percentual_feminino|default:"0" }}%</span> feminino
          </p>
        </div>
      </div>
    </div>

    <!-- Gênero por Neurodivergência -->
    <div class="col-lg-8 col-md-6 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Gênero por Neurodivergência</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="genero-neurodiv-chart" class="chart-canvas" height="170"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Distribuição das neurodivergências por gênero
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos de Ausências e Alunos por Profissional -->
  <div class="row mt-5">
    <!-- Gráfico de Ausências Mensais nos Atendimentos -->
    <div class="col-lg-6 col-md-12 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-warning shadow-warning border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Atendimentos Mensais</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="ausencias-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Quantitativo mensal de ausências nos atendimentos do ano atual
          </p>
        </div>
      </div>
    </div>
    
    <!-- Gráfico de Distribuição por Neurodivergência -->
    <div class="col-lg-6 col-md-12 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Distribuição por Neurodivergência</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="neurodivergencia-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Distribuição dos alunos por tipo de neurodivergência
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-5">
    <!-- Escolas com Maior Demanda -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-primary-pastel shadow-primary-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Escolas com Maior Demanda</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Escola</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Alunos</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Capacidade</th>
                </tr>
              </thead>
              <tbody>
                {% for escola in escolas_maior_demanda|default:'' %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ escola.nome }}</h6>
                        <p class="text-xs text-secondary mb-0">{{ escola.cidade }}/{{ escola.estado }}</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ escola.total_alunos }}</p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ escola.capacidade_atendimento }}</p>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center py-4">
                    <p class="text-sm mb-0">Nenhuma escola cadastrada</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Gráfico de Alunos por Profissional -->
    <div class="col-lg-6 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Alunos por Profissional</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="alunos-profissional-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Distribuição de Alunos/Pacientes por Profissional
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfico de Especialização dos Profissionais -->
  <div class="row mt-5">
    <div class="col-lg-6 col-md-12">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-success-pastel shadow-success-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Especialização dos Profissionais</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="especializacao-profissionais-chart" class="chart-canvas" height="400"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Distribuição de tipos de neurodivergência atendidos por cada profissional
          </p>
        </div>
      </div>
    </div>
    
    <!-- Tabela de Alerta de Alunos -->
    <div class="col-lg-6 col-md-12">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-danger-pastel shadow-danger-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Alerta de Alunos/Pacientes</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Aluno/Paciente</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Escola</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Tipos de Alerta</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Detalhes</th>
                </tr>
              </thead>
              <tbody id="alunos-em-risco-table">
                <tr>
                  <td colspan="4" class="text-center">Carregando dados...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Alunos que necessitam de atenção especial
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- NOVO GRÁFICO: Neurodivergências por Escola -->
  <div class="row mt-5">
    <div class="col-12 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Neurodivergências por Escola</h6>
          </div>
        </div>
        <div class="card-body">
          <canvas id="chart-neurodivergencias-escola" height="120"></canvas>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Quantidade de alunos por tipo de neurodivergência em cada escola
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertas e Ações Necessárias -->
  <div class="row mt-5">
    <div class="col-lg-6 col-md-6">
      <div class="card mb-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-warning-pastel shadow-warning-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Alunos sem Atendimento Recente</h6>
          </div>
        </div>
        <div class="px-3 pt-2">
          <p class="text-sm mb-0">
            <i class="fa fa-check text-info" aria-hidden="true"></i>
            <span class="font-weight-bold ms-1">{{ total_sem_atendimento|default:"0" }} alunos</span> sem atendimento há mais de 15 dias
          </p>
        </div>
        <div class="card-body px-0 pb-2">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Aluno/Paciente</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Último Atendimento</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Escola</th>
                </tr>
              </thead>
              <tbody>
                {% for aluno in alunos_sem_atendimento|default:'' %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      {% if aluno.foto_perfil %}
                      <div>
                        <img src="{{ aluno.foto_perfil.url }}" class="avatar avatar-sm me-3" alt="{{ aluno.nome_completo }}">
                      </div>
                      {% endif %}
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ aluno.nome_completo }}</h6>
                        <p class="text-xs text-secondary mb-0">{{ aluno.idade }} anos</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ aluno.ultimo_atendimento|date:"d/m/Y" }}</p>
                    <p class="text-xs text-secondary mb-0">{{ aluno.dias_sem_atendimento }} dias atrás</p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ aluno.escola.nome }}</p>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center py-4">
                    <p class="text-sm mb-0">Todos os alunos estão com atendimentos em dia</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-md-6">
      <div class="card mb-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Próximos Atendimentos</h6>
          </div>
        </div>
        <div class="px-3 pt-2">
          <p class="text-sm mb-0">
            <i class="fa fa-check text-info" aria-hidden="true"></i>
            <span class="font-weight-bold ms-1">{{ total_pdis_vencendo|default:"0" }} PDIs</span> ativos (iniciados ou em andamento)
          </p>
        </div>
        <div class="card-body px-0 pb-2">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Aluno/Paciente</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Data de Atendimento</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Escola</th>
                </tr>
              </thead>
              <tbody>
                {% for pdi in pdis_vencendo_lista|default:'' %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      {% if pdi.neurodivergente.foto_perfil %}
                      <div>
                        <img src="{{ pdi.neurodivergente.foto_perfil.url }}" class="avatar avatar-sm me-3" alt="{{ pdi.neurodivergente.nome_completo }}">
                      </div>
                      {% endif %}
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ pdi.neurodivergente.nome_completo }}</h6>
                        <p class="text-xs text-secondary mb-0">{% if pdi.neurodivergente.data_nascimento %}{{ pdi.neurodivergente.idade }} anos{% else %}Idade não informada{% endif %}</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ pdi.data_criacao|date:"d/m/Y" }}</p>
                    <p class="text-xs text-secondary mb-0">
                      {% if pdi.dias_restantes == 0 %}
                        Hoje
                      {% elif pdi.dias_restantes == 1 %}
                        Amanhã
                      {% else %}
                        Falta {{ pdi.dias_restantes }} dias
                      {% endif %}
                    </p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ pdi.neurodivergente.escola.nome|default:"Sem escola" }}</p>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center py-4">
                    <p class="text-sm mb-0">Nenhum PDI ativo no momento (iniciado ou em andamento)</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
  /* Cores pastel para os ícones do dashboard */
  .bg-gradient-primary-pastel {
    background-image: linear-gradient(195deg, #f8a5c2 0%, #e991b0 100%);
  }
  .shadow-primary-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(233, 30, 99, 0.2);
  }
  
  .bg-gradient-success-pastel {
    background-image: linear-gradient(195deg, #a8e6cf 0%, #7ddbb6 100%);
  }
  .shadow-success-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(76, 175, 80, 0.2);
  }
  
  .bg-gradient-info-pastel {
    background-image: linear-gradient(195deg, #a8d8f0 0%, #7bc8eb 100%);
  }
  .shadow-info-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(26, 115, 232, 0.2);
  }
  
  .bg-gradient-dark-pastel {
    background-image: linear-gradient(195deg, #b4b9c8 0%, #9ba1b5 100%);
  }
  .shadow-dark-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(64, 64, 64, 0.2);
  }
  
  .bg-gradient-warning-pastel {
    background-image: linear-gradient(195deg, #ffd3a5 0%, #fdbe7d 100%);
  }
  .shadow-warning-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(251, 140, 0, 0.2);
  }
  
  .bg-gradient-danger-pastel {
    background-image: linear-gradient(195deg, #ffb8b8 0%, #ff9d9d 100%);
  }
  .shadow-danger-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(244, 67, 53, 0.2);
  }
</style>
{% endblock %}

{% block extrajs %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configuração de cores
    const primaryColor = '#e91e63';
    const secondaryColor = '#7b809a';
    const infoColor = '#1A73E8';
    const successColor = '#4CAF50';
    const warningColor = '#fb8c00';
    const dangerColor = '#f44335';
    
    // Paleta de cores pastel para gráficos
    const pastelColors = [
      '#a8e6cf',  // Verde pastel
      '#f8d0d3',  // Rosa pastel
      '#a8d8f0',  // Azul pastel
      '#ffd3a5',  // Laranja pastel
      '#ffb8b8',  // Vermelho pastel
      '#d3b8ff',  // Roxo pastel
      '#ffe0a5',  // Amarelo pastel
      '#b4b9c8',  // Cinza pastel
      '#c5e0dc',  // Menta pastel
      '#f9d5e5',  // Rosa claro pastel
      '#e3f0ff',  // Azul claro pastel
      '#c4e17f'   // Verde limão pastel
    ];
    
    // Gráfico de Distribuição por Gênero
    const genderCtx = document.getElementById('gender-chart').getContext('2d');
    new Chart(genderCtx, {
      type: 'doughnut',
      data: {
        labels: ['Masculino', 'Feminino'],
        datasets: [{
          data: [{{ percentual_masculino|default:"0" }}, {{ percentual_feminino|default:"0" }}],
          backgroundColor: [
            '#a8d8f0',  // Azul pastel para masculino
            '#f8d0d3'   // Rosa pastel para feminino
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom'
          }
        },
        cutout: '70%'
      }
    });

    // Gráfico de Gênero por Neurodivergência
    fetch('/api/genero-por-neurodivergencia/')
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById('genero-neurodiv-chart').getContext('2d');
        
        // Aplicar cores pastel aos datasets
        if (data.datasets && data.datasets.length > 0) {
          data.datasets.forEach((dataset, index) => {
            dataset.backgroundColor = pastelColors[index % pastelColors.length];
          });
        }
        
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: data.datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: {
                    family: 'Roboto',
                    size: 13
                  }
                }
              },
              tooltip: {
                enabled: true
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  drawBorder: false,
                  display: true,
                  drawOnChartArea: true,
                  drawTicks: false,
                  borderDash: [5, 5]
                },
                ticks: {
                  display: true,
                  padding: 10,
                  color: '#b2b9bf',
                  stepSize: 1,
                  precision: 0,
                  callback: function(value) {
                    if (Math.floor(value) === value) {
                      return value;
                    }
                  },
                  font: {
                    size: 14,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 2
                  }
                }
              },
              x: {
                grid: {
                  drawBorder: false,
                  display: false,
                  drawOnChartArea: false,
                  drawTicks: false
                },
                ticks: {
                  display: false,
                  color: '#b2b9bf',
                  padding: 5,
                  maxRotation: 0,
                  minRotation: 0,
                  autoSkip: false,
                  font: {
                    size: 11,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 1.2
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados do gráfico de gênero por neurodivergência:', error);
      });

    // Gráfico de Distribuição por Neurodivergência
    fetch('/api/distribuicao-por-neurodivergencia/')
      .then(response => response.json())
      .then(data => {
        const neurodivergenciaCtx = document.getElementById('neurodivergencia-chart').getContext('2d');
        
        // Aplicar cores pastel aos datasets
        if (data.datasets && data.datasets.length > 0) {
          data.datasets[0].backgroundColor = pastelColors;
        }
        
        new Chart(neurodivergenciaCtx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: data.datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  drawBorder: false,
                  display: true,
                  drawOnChartArea: true,
                  drawTicks: false,
                  borderDash: [5, 5]
                },
                ticks: {
                  display: true,
                  padding: 10,
                  color: '#b2b9bf',
                  font: {
                    size: 11,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 2
                  }
                }
              },
              x: {
                grid: {
                  drawBorder: false,
                  display: false,
                  drawOnChartArea: false,
                  drawTicks: false
                },
                ticks: {
                  display: false,
                  color: '#b2b9bf',
                  padding: 10,
                  font: {
                    size: 11,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 2
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados do gráfico de distribuição por neurodivergência:', error);
      });

    // Gráfico de Ausências Mensais nos Atendimentos
    fetch('/api/ausencias-por-aluno/')
      .then(response => response.json())
      .then(data => {
        const ausenciasCtx = document.getElementById('ausencias-chart').getContext('2d');
        
        // Armazenar os dados originais para cada dataset
        const originalData = {
          labels: [...data.labels],
          datasets: [
            {
              label: 'Ausências',
              data: [...data.ausencias],
              backgroundColor: '#ff6b6b', // Vermelho
              borderColor: '#ff5252',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Presenças',
              data: [...data.presencas],
              backgroundColor: pastelColors[2], // Verde pastel
              borderColor: '#a8e6cf',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Em andamento',
              data: [...data.em_andamento],
              backgroundColor: pastelColors[0], // Azul pastel
              borderColor: '#a8d8f0',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Iniciado',
              data: [...data.iniciado],
              backgroundColor: pastelColors[5], // Amarelo pastel
              borderColor: '#fff9a5',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Suspenso',
              data: [...data.suspenso],
              backgroundColor: pastelColors[6], // Roxo pastel
              borderColor: '#d3b8ff',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Cancelado',
              data: [...data.cancelado],
              backgroundColor: pastelColors[4], // Vermelho pastel
              borderColor: '#ffb8b8',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            }
          ]
        };
        
        // Inicializar o gráfico com todos os dados
        const ausenciasChart = new Chart(ausenciasCtx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [
              {
                label: 'Ausências',
                data: data.ausencias,
                backgroundColor: '#ff6b6b', // Vermelho
                borderColor: '#ff5252',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Presenças',
                data: data.presencas,
                backgroundColor: pastelColors[2], // Verde pastel
                borderColor: '#a8e6cf',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Em andamento',
                data: data.em_andamento,
                backgroundColor: pastelColors[0], // Azul pastel
                borderColor: '#a8d8f0',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Iniciado',
                data: data.iniciado,
                backgroundColor: pastelColors[5], // Amarelo pastel
                borderColor: '#fff9a5',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Suspenso',
                data: data.suspenso,
                backgroundColor: pastelColors[6], // Roxo pastel
                borderColor: '#d3b8ff',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Cancelado',
                data: data.cancelado,
                backgroundColor: pastelColors[4], // Vermelho pastel
                borderColor: '#ffb8b8',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: {
                    family: 'Roboto',
                    size: 13
                  }
                },
                onClick: function(e, legendItem, legend) {
                  // Obter o índice do dataset
                  const index = legendItem.datasetIndex;
                  
                  // Alternar a visibilidade do dataset
                  const meta = ausenciasChart.getDatasetMeta(index);
                  meta.hidden = meta.hidden === null ? !ausenciasChart.data.datasets[index].hidden : null;
                  
                  // Verificar quais datasets estão visíveis
                  const visibleDatasets = [];
                  for (let i = 0; i < ausenciasChart.data.datasets.length; i++) {
                    const meta = ausenciasChart.getDatasetMeta(i);
                    if (!meta.hidden) {
                      visibleDatasets.push(i);
                    }
                  }
                  
                  // Verificar quais meses têm dados em datasets visíveis
                  const monthsWithData = {};
                  originalData.labels.forEach((month, monthIndex) => {
                    monthsWithData[month] = false;
                    
                    visibleDatasets.forEach(datasetIndex => {
                      if (originalData.datasets[datasetIndex].data[monthIndex] > 0) {
                        monthsWithData[month] = true;
                      }
                    });
                  });
                  
                  // Filtrar os labels para incluir apenas meses com dados
                  const newLabels = [];
                  const monthIndices = [];
                  
                  originalData.labels.forEach((month, index) => {
                    if (monthsWithData[month]) {
                      newLabels.push(month);
                      monthIndices.push(index);
                    }
                  });
                  
                  // Atualizar os labels do gráfico
                  ausenciasChart.data.labels = newLabels;
                  
                  // Atualizar os dados de cada dataset para incluir apenas os meses com dados
                  ausenciasChart.data.datasets.forEach((dataset, datasetIndex) => {
                    const newData = [];
                    monthIndices.forEach(monthIndex => {
                      newData.push(originalData.datasets[datasetIndex].data[monthIndex]);
                    });
                    dataset.data = newData;
                  });
                  
                  // Atualizar o gráfico
                  ausenciasChart.update();
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    if (context.raw > 0) {
                      return `${context.dataset.label}: ${context.raw}`;
                    } else {
                      return null;
                    }
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                stacked: false,
                suggestedMax: Math.max(...data.ausencias, ...data.presencas, ...data.em_andamento, ...data.iniciado, ...data.suspenso, ...data.cancelado) * 1.2,
                grid: {
                  drawBorder: false,
                  display: true,
                  drawOnChartArea: true,
                  drawTicks: false,
                  borderDash: [5, 5]
                },
                ticks: {
                  display: true,
                  padding: 10,
                  color: '#b2b9bf',
                  stepSize: 1,
                  precision: 0,
                  callback: function(value) {
                    if (Math.floor(value) === value) {
                      return value;
                    }
                  },
                  font: {
                    size: 14,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 2
                  }
                }
              },
              x: {
                stacked: false,
                grid: {
                  drawBorder: false,
                  display: false,
                  drawOnChartArea: false,
                  drawTicks: false
                },
                ticks: {
                  display: true,
                  color: '#b2b9bf',
                  padding: 10,
                  maxRotation: 0,
                  minRotation: 0,
                  autoSkip: false,
                  font: {
                    size: 12,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 1.2
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Erro ao carregar dados de ausências:', error));

    // Gráfico de Alunos por Profissional
    fetch('/api/alunos-por-profissional/')
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById('alunos-profissional-chart').getContext('2d');
        
        // Usar a paleta de cores pastel para o gráfico de pizza
        const datasetData = data.datasets[0].data;
        
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Alunos',
              data: datasetData,
              backgroundColor: pastelColors.slice(0, datasetData.length),
              borderWidth: 0,
              hoverOffset: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                display: true,
                position: 'right',
                labels: {
                  font: {
                    family: 'Roboto',
                    size: 12
                  },
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    const label = context.chart.data.labels[context.dataIndex];
                    return `${label}: ${context.raw} alunos`;
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Erro ao carregar dados de alunos por profissional:', error));

    // Gráfico de Especialização dos Profissionais
    fetch('/api/especializacao-profissionais/')
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById('especializacao-profissionais-chart').getContext('2d');
        
        // Aplicar cores pastel aos datasets
        if (data.datasets && data.datasets.length > 0) {
          data.datasets.forEach((dataset, index) => {
            const colorIndex = index % pastelColors.length;
            const color = pastelColors[colorIndex];
            
            dataset.backgroundColor = `${color}33`; // Adiciona transparência (20%)
            dataset.borderColor = color;
            dataset.pointBackgroundColor = color;
            dataset.pointBorderColor = '#fff';
            dataset.pointHoverBackgroundColor = '#fff';
            dataset.pointHoverBorderColor = color;
          });
        }
        
        new Chart(ctx, {
          type: 'radar',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
              line: {
                borderWidth: 2
              },
              point: {
                radius: 3,
                hitRadius: 10,
                hoverRadius: 5
              }
            },
            scales: {
              r: {
                angleLines: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                  beginAtZero: true,
                  stepSize: 1,
                  font: {
                    family: 'Roboto, Helvetica, Arial, sans-serif',
                    size: 11
                  }
                },
                pointLabels: {
                  font: {
                    family: 'Roboto, Helvetica, Arial, sans-serif',
                    size: 12,
                    weight: 'bold'
                  }
                }
              }
            },
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  font: {
                    family: 'Roboto, Helvetica, Arial, sans-serif',
                    size: 12
                  },
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.raw} alunos`;
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados de especialização dos profissionais:', error);
      });

    // Tabela de Alerta de Alunos em Risco
    fetch('/api/alunos-em-risco/')
      .then(response => response.json())
      .then(data => {
        const tableBody = document.getElementById('alunos-em-risco-table');
        tableBody.innerHTML = '';
        
        if (data.alunos_risco && data.alunos_risco.length > 0) {
          // Agrupar alunos por ID
          const alunosAgrupados = {};
          
          // Primeiro passo: agrupar os dados por aluno
          data.alunos_risco.forEach(aluno => {
            if (!alunosAgrupados[aluno.id]) {
              alunosAgrupados[aluno.id] = {
                id: aluno.id,
                nome: aluno.nome,
                escola: aluno.escola,
                riscos: []
              };
            }
            
            // Adicionar este risco à lista de riscos do aluno
            alunosAgrupados[aluno.id].riscos.push({
              tipo: aluno.tipo_risco,
              detalhe: aluno.detalhe,
              severidade: aluno.severidade
            });
          });
          
          // Segundo passo: criar as linhas da tabela, uma para cada aluno
          Object.values(alunosAgrupados).forEach(aluno => {
            const row = document.createElement('tr');
            
            // Consolidar todos os tipos de risco em uma única string
            const tiposRisco = aluno.riscos.map(risco => {
              let severidadeClass = '';
              if (risco.severidade === 'alta') {
                severidadeClass = 'text-danger';
              } else if (risco.severidade === 'média') {
                severidadeClass = 'text-warning';
              } else {
                severidadeClass = 'text-info';
              }
              
              return `<span class="${severidadeClass}">${risco.tipo}</span>`;
            }).join('<br>');
            
            // Consolidar todos os detalhes em uma única string
            const detalhes = aluno.riscos.map(risco => {
              let severidadeClass = '';
              if (risco.severidade === 'alta') {
                severidadeClass = 'text-danger';
              } else if (risco.severidade === 'média') {
                severidadeClass = 'text-warning';
              } else {
                severidadeClass = 'text-info';
              }
              
              return `<span class="${severidadeClass}">${risco.detalhe}</span>`;
            }).join('<br>');
            
            row.innerHTML = `
              <td>
                <div class="d-flex px-2 py-1">
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">${aluno.nome}</h6>
                  </div>
                </div>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${aluno.escola}</p>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${tiposRisco}</p>
              </td>
              <td>
                <p class="text-xs text-secondary mb-0">${detalhes}</p>
              </td>
            `;
            
            tableBody.appendChild(row);
          });
        } else {
          tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum aluno em situação de risco encontrado</td></tr>';
        }
      })
      .catch(error => {
        console.error('Erro ao carregar dados de alerta de alunos em risco:', error);
        document.getElementById('alunos-em-risco-table').innerHTML = 
          '<tr><td colspan="4" class="text-center text-danger">Erro ao carregar dados</td></tr>';
      });

    // NOVO GRÁFICO: Neurodivergências por Escola
    fetch('/neurodivergentes/api/neurodivergencias-por-escola/')
      .then(response => response.json())
      .then(data => {
        // data.labels: nomes das escolas
        // data.datasets: lista de datasets (um para cada neurodivergência)
        const ctx = document.getElementById('chart-neurodivergencias-escola').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: data.datasets
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.raw}`;
                  }
                }
              }
            },
            scales: {
              x: { stacked: true, ticks: { display: false } },
              y: { stacked: true, beginAtZero: true }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados do gráfico de neurodivergências por escola:', error);
      });
  });
</script>
{% endblock %}
