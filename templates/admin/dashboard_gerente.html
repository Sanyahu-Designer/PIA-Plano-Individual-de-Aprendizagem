{% extends "admin/base_material.html" %}
{% load i18n static %}

{% block title %}Dashboard | {{ site_title|default:_('PIA') }}{% endblock %}

{% block content %}
<style>
/* Base para TVs grandes - 55" e 65" Full HD (1366px+) */
@media (min-width: 1366px) {
  .container-fluid {
    max-width: 1280px;
    margin: 0 auto;
  }
  
  /* Fontes maiores para leitura à distância */
  h4 { font-size: 1.6rem !important; }
  h6 { font-size: 1.1rem !important; }
  .text-sm { font-size: 0.95rem !important; }
  
  /* Cards com mais padding */
  .card-body { padding: 1.8rem !important; }
  .card-header { padding: 1.3rem !important; }
  
  /* Gráficos otimizados */
  canvas {
    max-height: 450px !important;
  }
  
  /* Espaçamento adequado */
  .row.mt-5 { margin-top: 3.5rem !important; }
  
  /* Ícones maiores */
  .icon-lg {
    width: 70px !important;
    height: 70px !important;
  }
  
  /* Tabelas legíveis */
  .table td, .table th {
    padding: 0.9rem !important;
    font-size: 1rem !important;
  }
}

/* TVs Full HD - 55" e 65" (1920px+) */
@media (min-width: 1920px) {
  .container-fluid {
    max-width: 1800px;
    margin: 0 auto;
  }
  
  /* Aumentar fontes para leitura à distância */
  h4 { font-size: 1.9rem !important; }
  h6 { font-size: 1.3rem !important; }
  .text-sm { font-size: 1.05rem !important; }
  
  /* Aumentar padding dos cards */
  .card-body { padding: 2.2rem !important; }
  .card-header { padding: 1.6rem !important; }
  
  /* Controlar altura dos gráficos */
  canvas {
    max-height: 520px !important;
  }
  
  /* Espaçamento entre seções */
  .row.mt-5 { margin-top: 4rem !important; }
  
  /* Ajustar ícones */
  .icon-lg {
    width: 85px !important;
    height: 85px !important;
  }
  
  /* Tabelas mais legíveis */
  .table td, .table th {
    padding: 1.1rem !important;
    font-size: 1.15rem !important;
  }
  
  /* Botões maiores para TVs */
  .btn {
    padding: 0.7rem 1.3rem !important;
    font-size: 1.05rem !important;
  }
  
  /* Cards de estatísticas com altura mínima */
  .col-xl-3 .card {
    min-height: 180px;
  }
}

/* TVs 4K pequenas - 75" (2560px+) */
@media (min-width: 2560px) {
  .container-fluid {
    max-width: 2400px;
  }
  
  /* Fontes otimizadas para 75" */
  h4 { font-size: 2.3rem !important; }
  h6 { font-size: 1.5rem !important; }
  .text-sm { font-size: 1.25rem !important; }
  
  /* Padding aumentado */
  .card-body { padding: 3.2rem !important; }
  .card-header { padding: 2.2rem !important; }
  
  /* Gráficos maiores mas controlados */
  canvas {
    max-height: 620px !important;
  }
  
  /* Espaçamento generoso */
  .row.mt-5 { margin-top: 5rem !important; }
  .py-4 { padding-top: 3.2rem !important; padding-bottom: 3.2rem !important; }
  
  /* Ícones grandes */
  .icon-lg {
    width: 105px !important;
    height: 105px !important;
  }
  
  /* Tabelas 4K */
  .table td, .table th {
    padding: 1.6rem !important;
    font-size: 1.35rem !important;
  }
  
  /* Botões maiores */
  .btn {
    padding: 0.9rem 1.6rem !important;
    font-size: 1.15rem !important;
  }
  
  /* Cards de estatísticas maiores */
  .col-xl-3 .card {
    min-height: 220px;
  }
  
  /* Melhor espaçamento em colunas */
  .col-xl-3, .col-lg-6 {
    margin-bottom: 2rem !important;
  }
}

/* TVs 4K grandes - 86" e maiores (3840px+) */
@media (min-width: 3840px) {
  .container-fluid {
    max-width: 3600px;
  }
  
  /* Fontes para TVs 86" */
  h4 { font-size: 3rem !important; }
  h6 { font-size: 2rem !important; }
  .text-sm { font-size: 1.5rem !important; }
  .text-xs { font-size: 1.2rem !important; }
  
  /* Padding máximo para visualização à distância */
  .card-body { padding: 4.5rem !important; }
  .card-header { padding: 3rem !important; }
  
  /* Gráficos otimizados para TVs grandes */
  canvas {
    max-height: 850px !important;
  }
  
  /* Espaçamento máximo */
  .row.mt-5 { margin-top: 6rem !important; }
  .py-4 { padding-top: 4rem !important; padding-bottom: 4rem !important; }
  
  /* Ícones muito grandes */
  .icon-lg {
    width: 130px !important;
    height: 130px !important;
  }
  
  /* Tabelas para TVs grandes */
  .table td, .table th {
    padding: 2rem !important;
    font-size: 1.6rem !important;
  }
  
  /* Botões grandes para TVs */
  .btn {
    padding: 1.2rem 2rem !important;
    font-size: 1.4rem !important;
  }
  
  /* Cards de estatísticas muito maiores */
  .col-xl-3 .card {
    min-height: 280px;
  }
  
  /* Espaçamento generoso entre colunas */
  .col-xl-3, .col-lg-6 {
    margin-bottom: 3rem !important;
  }
  
  /* Breadcrumbs maiores */
  .breadcrumb-item {
    font-size: 1.3rem !important;
  }
  
  /* Navbar mais alta */
  .navbar {
    padding: 1.5rem 0 !important;
  }
}

/* Otimizações gerais para todas as TVs */
@media (min-width: 1366px) {
  /* Melhorar contraste e legibilidade */
  .card {
    box-shadow: 0 8px 26px -4px rgba(20, 20, 20, 0.15) !important;
  }
  
  /* Gráficos responsivos */
  .chart-container {
    position: relative;
    width: 100%;
    height: auto;
  }
  
  /* Tabelas com scroll horizontal se necessário */
  .table-responsive {
    font-size: inherit !important;
  }
  
  /* Melhorar espaçamento dos badges */
  .badge {
    padding: 0.5em 0.8em !important;
    font-size: 0.9em !important;
  }
  
  /* Cards de gráficos com altura mínima */
  .card-body canvas {
    min-height: 300px !important;
  }
  
  /* Melhorar visibilidade dos links */
  a {
    text-decoration: none !important;
  }
  
  a:hover {
    text-decoration: underline !important;
  }
  
  /* Otimizar tooltips para TVs */
  .tooltip {
    font-size: 1.1rem !important;
  }
  
  /* Melhorar espaçamento em listas */
  .list-group-item {
    padding: 1rem 1.5rem !important;
  }
  
  /* Scroll suave em tabelas grandes */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
}
</style>

<div class="container-fluid py-4">
  <!-- Estatísticas Principais -->
  <div class="row">
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-primary-pastel shadow-primary-pastel text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">person</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Total de Alunos</p>
            <h4 class="mb-0">{{ total_alunos|default:"0" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2">
          <p class="mb-0"><span class="text-success text-sm font-weight-bolder">+{{ novos_alunos_mes|default:"0" }} </span>novos este mês</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-success-pastel shadow-success-pastel text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">psychology</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Neurodivergências</p>
            <h4 class="mb-0">{{ total_neurodivergencias|default:"0" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2">
          <p class="mb-0">Tipos diferentes registrados</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-info-pastel shadow-info-pastel text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">search</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Em Investigação</p>
            <h4 class="mb-0">{{ total_alunos_investigacao|default:"0" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2">
          <p class="mb-0">Neurodivergência ausente</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-sm-6">
      <div class="card">
        <div class="card-header p-3 pt-2">
          <div class="icon icon-lg icon-shape bg-gradient-dark-pastel shadow-dark-pastel text-center border-radius-xl mt-n4 position-absolute">
            <i class="material-symbols-rounded opacity-10">school</i>
          </div>
          <div class="text-end pt-1">
            <p class="text-sm mb-0 text-capitalize">Total de Profissionais</p>
            <h4 class="mb-0">{{ total_profissionais|default:"0" }}</h4>
          </div>
        </div>
        <hr class="dark horizontal my-0">
        <div class="card-footer p-2">
          <p class="mb-0"><span class="text-success text-sm font-weight-bolder">{{ profissionais_saude|default:"0" }}</span> da Saúde | <span class="text-info text-sm font-weight-bolder">{{ profissionais_educacao|default:"0" }}</span> da Educação</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos e Tabelas -->
  <div class="row mt-5">
    <!-- Distribuição por Gênero e Idade -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-primary-pastel shadow-primary-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Distribuição por Gênero</h6>
          </div>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="gender-chart" class="chart-canvas" height="170"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            <span class="text-success text-sm font-weight-bolder">{{ percentual_masculino|default:"0" }}%</span> masculino | 
            <span class="text-info text-sm font-weight-bolder">{{ percentual_feminino|default:"0" }}%</span> feminino
          </p>
        </div>
      </div>
    </div>

    <!-- Gênero por Neurodivergência -->
    <div class="col-lg-8 col-md-6 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Gênero por Neurodivergência</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="genero-neurodiv-chart" class="chart-canvas" height="170"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Distribuição das neurodivergências por gênero
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos de Ausências e Alunos por Profissional -->
  <div class="row mt-5">
    <!-- Gráfico de Ausências Mensais nos Atendimentos -->
    <div class="col-lg-6 col-md-12 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-warning shadow-warning border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Atendimentos Mensais</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="ausencias-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Quantitativo mensal de ausências nos atendimentos do ano atual
          </p>
        </div>
      </div>
    </div>
    
    <!-- Gráfico de Distribuição por Neurodivergência -->
    <div class="col-lg-6 col-md-12 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Distribuição por Neurodivergência</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="neurodivergencia-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Distribuição dos alunos por tipo de neurodivergência
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-5">
    <!-- Escolas com Maior Demanda -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-primary-pastel shadow-primary-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Escolas com Maior Demanda</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="table-responsive" style="max-height: 335px; overflow-y: auto; overflow-x: hidden;">
            <table class="table align-items-center mb-0">
              <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Escola</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Alunos</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Capacidade</th>
                </tr>
              </thead>
              <tbody>
                {% for escola in escolas_maior_demanda|default:'' %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ escola.nome }}</h6>
                        <p class="text-xs text-secondary mb-0">{{ escola.cidade }}/{{ escola.estado }}</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ escola.total_alunos }}</p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ escola.capacidade_atendimento }}</p>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center py-4">
                    <p class="text-sm mb-0">Nenhuma escola cadastrada</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Gráfico de Alunos por Profissional -->
    <div class="col-lg-6 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Alunos por Profissional</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="alunos-profissional-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Distribuição de Alunos/Pacientes por Profissional
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfico de Especialização dos Profissionais -->
  <div class="row mt-5">
    <div class="col-lg-6 col-md-12">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-success-pastel shadow-success-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Especialização dos Profissionais</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="especializacao-profissionais-chart" class="chart-canvas" height="400"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Distribuição de tipos de neurodivergência atendidos por cada profissional
          </p>
        </div>
      </div>
    </div>
    
    <!-- Novo Gráfico: Atendimentos Mensais por Profissional -->
    <div class="col-lg-6 col-md-12">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-warning-pastel shadow-warning-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Atendimentos Mensais por Profissional</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <!-- Filtros -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="filtro-profissional" class="form-label text-xs">Profissional:</label>
              <select id="filtro-profissional" class="form-select form-select-sm">
                <option value="">Todos os profissionais</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="filtro-mes" class="form-label text-xs">Período:</label>
              <select id="filtro-mes" class="form-select form-select-sm">
                <option value="">Últimos 12 meses</option>
              </select>
            </div>
          </div>
          <!-- Gráfico -->
          <div style="height: 300px; position: relative;">
            <canvas id="chart-atendimentos-profissional"></canvas>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Acompanhe a produtividade dos profissionais ao longo do tempo
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- NOVO GRÁFICO: Neurodivergências por Escola -->
  <div class="row mt-5">
    <div class="col-12 mb-4">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Neurodivergências por Escola</h6>
          </div>
        </div>
        <div class="card-body">
          <canvas id="chart-neurodivergencias-escola" height="120"></canvas>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm">
            Quantidade de alunos por tipo de neurodivergência em cada escola
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela de Alerta de Alunos/Pacientes - Linha Única -->
  <div class="row mt-5">
    <div class="col-12">
      <div class="card z-index-2">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-danger-pastel shadow-danger-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Alerta de Alunos/Pacientes</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table align-items-center mb-0">
              <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Aluno/Paciente</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Escola</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Profissional</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Tipos de Alerta</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Detalhes</th>
                </tr>
              </thead>
              <tbody id="alunos-em-risco-table">
                <tr>
                  <td colspan="5" class="text-center">Carregando dados...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer p-2">
          <p class="mb-0 text-sm" id="alunos-em-risco-info">
            Alunos que necessitam de atenção especial
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertas e Ações Necessárias -->
  <div class="row mt-5">
    <div class="col-lg-6 col-md-6">
      <div class="card mb-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-warning-pastel shadow-warning-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Alunos sem Atendimento Recente</h6>
          </div>
        </div>
        <div class="px-3 pt-2">
          <p class="text-sm mb-0">
            <i class="fa fa-check text-info" aria-hidden="true"></i>
            <span class="font-weight-bold ms-1">{{ total_sem_atendimento|default:"0" }} alunos</span> sem atendimento há mais de 15 dias
          </p>
        </div>
        <div class="card-body px-0 pb-2">
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table align-items-center mb-0">
              <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Aluno/Paciente</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Último Atendimento</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Profissional</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Escola</th>
                </tr>
              </thead>
              <tbody>
                {% for aluno in alunos_sem_atendimento|default:'' %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      {% if aluno.foto_perfil %}
                      <div>
                        <img src="{{ aluno.foto_perfil.url }}" class="avatar avatar-sm me-3" alt="{{ aluno.nome_completo }}">
                      </div>
                      {% endif %}
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ aluno.nome_completo }}</h6>
                        <p class="text-xs text-secondary mb-0">{{ aluno.idade }} anos</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ aluno.ultimo_atendimento|date:"d/m/Y" }}</p>
                    <p class="text-xs text-secondary mb-0">{{ aluno.dias_sem_atendimento }} dias atrás</p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ aluno.profissional_responsavel|default:"Não informado" }}</p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ aluno.escola.nome }}</p>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center py-4">
                    <p class="text-sm mb-0">Todos os alunos estão com atendimentos em dia</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-md-6">
      <div class="card mb-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2 bg-transparent">
          <div class="bg-gradient-info-pastel shadow-info-pastel border-radius-lg py-3 pe-1">
            <h6 class="text-white text-capitalize ps-3 mb-0">Próximos Atendimentos</h6>
          </div>
        </div>
        <div class="px-3 pt-2">
          <p class="text-sm mb-0">
            <i class="fa fa-check text-info" aria-hidden="true"></i>
            <span class="font-weight-bold ms-1">{{ total_pdis_vencendo|default:"0" }} PDIs</span> ativos (iniciados ou em andamento)
          </p>
        </div>
        <div class="card-body px-0 pb-2">
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table align-items-center mb-0">
              <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Aluno/Paciente</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Data de Atendimento</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Profissional</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Escola</th>
                </tr>
              </thead>
              <tbody>
                {% for pdi in pdis_vencendo_lista|default:'' %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      {% if pdi.neurodivergente.foto_perfil %}
                      <div>
                        <img src="{{ pdi.neurodivergente.foto_perfil.url }}" class="avatar avatar-sm me-3" alt="{{ pdi.neurodivergente.nome_completo }}">
                      </div>
                      {% endif %}
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">{{ pdi.neurodivergente.nome_completo }}</h6>
                        <p class="text-xs text-secondary mb-0">{% if pdi.neurodivergente.data_nascimento %}{{ pdi.neurodivergente.idade }} anos{% else %}Idade não informada{% endif %}</p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ pdi.data_criacao|date:"d/m/Y" }}</p>
                    <p class="text-xs text-secondary mb-0">
                      {% if pdi.dias_restantes == 0 %}
                        Hoje
                      {% elif pdi.dias_restantes == 1 %}
                        Amanhã
                      {% else %}
                        Falta {{ pdi.dias_restantes }} dias
                      {% endif %}
                    </p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ pdi.neurodivergente.profissional_responsavel|default:"Não informado" }}</p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ pdi.neurodivergente.escola.nome|default:"Sem escola" }}</p>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center py-4">
                    <p class="text-sm mb-0">Nenhum PDI ativo no momento (iniciado ou em andamento)</p>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
  /* Cores pastel para os ícones do dashboard */
  .bg-gradient-primary-pastel {
    background-image: linear-gradient(195deg, #f8a5c2 0%, #e991b0 100%);
  }
  .shadow-primary-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(233, 30, 99, 0.2);
  }
  
  .bg-gradient-success-pastel {
    background-image: linear-gradient(195deg, #a8e6cf 0%, #7ddbb6 100%);
  }
  .shadow-success-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(76, 175, 80, 0.2);
  }
  
  .bg-gradient-info-pastel {
    background-image: linear-gradient(195deg, #a8d8f0 0%, #7bc8eb 100%);
  }
  .shadow-info-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(26, 115, 232, 0.2);
  }
  
  .bg-gradient-dark-pastel {
    background-image: linear-gradient(195deg, #b4b9c8 0%, #9ba1b5 100%);
  }
  .shadow-dark-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(64, 64, 64, 0.2);
  }
  
  .bg-gradient-warning-pastel {
    background-image: linear-gradient(195deg, #ffd3a5 0%, #fdbe7d 100%);
  }
  .shadow-warning-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(251, 140, 0, 0.2);
  }
  
  .bg-gradient-danger-pastel {
    background-image: linear-gradient(195deg, #ffb8b8 0%, #ff9d9d 100%);
  }
  .shadow-danger-pastel {
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.14), 0 7px 10px -5px rgba(244, 67, 53, 0.2);
  }
</style>

<style>
  /* --- CORREÇÃO DE SOBREPOSIÇÃO DOS GRÁFICOS --- */
  #genero-neurodiv-chart, .chart-canvas {
    position: relative !important;
    z-index: 10 !important;
    pointer-events: auto !important;
  }
  .card, .card-body, .chart, .row.mt-5 {
    z-index: 1 !important;
    position: relative !important;
  }
</style>
<script>
// Remover overlays comuns que possam cobrir o gráfico ao carregar a página
window.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.popover, .modal-backdrop, .tour-overlay, .tour-popover-fix').forEach(el => el.remove());
  var canvas = document.getElementById('genero-neurodiv-chart');
  if (canvas) {
    canvas.style.pointerEvents = 'auto';
    canvas.style.zIndex = '10';
    if (canvas.parentElement) canvas.parentElement.style.zIndex = '10';
  }
});
</script>

{% endblock %}

{% block extrajs %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configuração de cores
    const primaryColor = '#e91e63';
    const secondaryColor = '#7b809a';
    const infoColor = '#1A73E8';
    const successColor = '#4CAF50';
    const warningColor = '#fb8c00';
    const dangerColor = '#f44335';
    
    // Paleta de cores pastel para gráficos
    const pastelColors = [
      '#a8e6cf',  // Verde pastel
      '#f8d0d3',  // Rosa pastel
      '#a8d8f0',  // Azul pastel
      '#ffd3a5',  // Laranja pastel
      '#ffb8b8',  // Vermelho pastel
      '#d3b8ff',  // Roxo pastel
      '#ffe0a5',  // Amarelo pastel
      '#b4b9c8',  // Cinza pastel
      '#c5e0dc',  // Menta pastel
      '#f9d5e5',  // Rosa claro pastel
      '#e3f0ff',  // Azul claro pastel
      '#c4e17f'   // Verde limão pastel
    ];
    
    // Gráfico de Distribuição por Gênero
    const genderCtx = document.getElementById('gender-chart').getContext('2d');
    new Chart(genderCtx, {
      type: 'doughnut',
      data: {
        labels: ['Masculino', 'Feminino'],
        datasets: [{
          data: [{{ percentual_masculino|default:"0" }}, {{ percentual_feminino|default:"0" }}],
          backgroundColor: [
            '#a8d8f0',  // Azul pastel para masculino
            '#f8d0d3'   // Rosa pastel para feminino
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom'
          }
        },
        cutout: '70%'
      }
    });

    // Gráfico de Gênero por Neurodivergência
    fetch('/api/genero-por-neurodivergencia/')
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById('genero-neurodiv-chart').getContext('2d');
        
        // Aplicar cores pastel aos datasets
        if (data.datasets && data.datasets.length > 0) {
          data.datasets.forEach((dataset, index) => {
            dataset.backgroundColor = pastelColors[index % pastelColors.length];
          });
        }
        
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: data.datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: {
                    family: 'Roboto',
                    size: 13
                  }
                }
              },
              tooltip: {
                enabled: true
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  drawBorder: false,
                  display: true,
                  drawOnChartArea: true,
                  drawTicks: false,
                  borderDash: [5, 5]
                },
                ticks: {
                  display: true,
                  padding: 10,
                  color: '#b2b9bf',
                  stepSize: 1,
                  precision: 0,
                  callback: function(value) {
                    if (Math.floor(value) === value) {
                      return value;
                    }
                  },
                  font: {
                    size: 14,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 2
                  }
                }
              },
              x: {
                grid: {
                  drawBorder: false,
                  display: false,
                  drawOnChartArea: false,
                  drawTicks: false
                },
                ticks: {
                  display: false,
                  color: '#b2b9bf',
                  padding: 5,
                  maxRotation: 0,
                  minRotation: 0,
                  autoSkip: false,
                  font: {
                    size: 11,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 1.2
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados do gráfico de gênero por neurodivergência:', error);
      });

    // Gráfico de Distribuição por Neurodivergência
    fetch('/api/distribuicao-por-neurodivergencia/')
      .then(response => response.json())
      .then(data => {
        const neurodivergenciaCtx = document.getElementById('neurodivergencia-chart').getContext('2d');
        
        // Aplicar cores pastel aos datasets
        if (data.datasets && data.datasets.length > 0) {
          data.datasets[0].backgroundColor = pastelColors;
        }
        
        new Chart(neurodivergenciaCtx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: data.datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  drawBorder: false,
                  display: true,
                  drawOnChartArea: true,
                  drawTicks: false,
                  borderDash: [5, 5]
                },
                ticks: {
                  display: true,
                  padding: 10,
                  color: '#b2b9bf',
                  font: {
                    size: 11,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 2
                  }
                }
              },
              x: {
                grid: {
                  drawBorder: false,
                  display: false,
                  drawOnChartArea: false,
                  drawTicks: false
                },
                ticks: {
                  display: false,
                  color: '#b2b9bf',
                  padding: 10,
                  font: {
                    size: 11,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 2
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados do gráfico de distribuição por neurodivergência:', error);
      });

    // Gráfico de Ausências Mensais nos Atendimentos
    fetch('/api/ausencias-por-aluno/')
      .then(response => response.json())
      .then(data => {
        const ausenciasCtx = document.getElementById('ausencias-chart').getContext('2d');
        
        // Armazenar os dados originais para cada dataset
        const originalData = {
          labels: [...data.labels],
          datasets: [
            {
              label: 'Ausências',
              data: [...data.ausencias],
              backgroundColor: '#ff6b6b', // Vermelho
              borderColor: '#ff5252',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Presenças',
              data: [...data.presencas],
              backgroundColor: pastelColors[2], // Verde pastel
              borderColor: '#a8e6cf',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Em planejamento',
              data: [...data.em_andamento],
              backgroundColor: pastelColors[0], // Azul pastel
              borderColor: '#a8d8f0',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Iniciado',
              data: [...data.iniciado],
              backgroundColor: pastelColors[5], // Amarelo pastel
              borderColor: '#fff9a5',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Suspenso',
              data: [...data.suspenso],
              backgroundColor: pastelColors[6], // Roxo pastel
              borderColor: '#d3b8ff',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            },
            {
              label: 'Cancelado',
              data: [...data.cancelado],
              backgroundColor: pastelColors[4], // Vermelho pastel
              borderColor: '#ffb8b8',
              borderWidth: 1,
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            }
          ]
        };
        
        // Inicializar o gráfico com todos os dados
        const ausenciasChart = new Chart(ausenciasCtx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [
              {
                label: 'Ausências',
                data: data.ausencias,
                backgroundColor: '#ff6b6b', // Vermelho
                borderColor: '#ff5252',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Presenças',
                data: data.presencas,
                backgroundColor: pastelColors[2], // Verde pastel
                borderColor: '#a8e6cf',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Em planejamento',
                data: data.em_andamento,
                backgroundColor: pastelColors[0], // Azul pastel
                borderColor: '#a8d8f0',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Iniciado',
                data: data.iniciado,
                backgroundColor: pastelColors[5], // Amarelo pastel
                borderColor: '#fff9a5',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Suspenso',
                data: data.suspenso,
                backgroundColor: pastelColors[6], // Roxo pastel
                borderColor: '#d3b8ff',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              },
              {
                label: 'Cancelado',
                data: data.cancelado,
                backgroundColor: pastelColors[4], // Vermelho pastel
                borderColor: '#ffb8b8',
                borderWidth: 1,
                borderRadius: 4,
                barPercentage: 0.6,
                categoryPercentage: 0.8
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: {
                    family: 'Roboto',
                    size: 13
                  }
                },
                onClick: function(e, legendItem, legend) {
                  // Obter o índice do dataset
                  const index = legendItem.datasetIndex;
                  
                  // Alternar a visibilidade do dataset
                  const meta = ausenciasChart.getDatasetMeta(index);
                  meta.hidden = meta.hidden === null ? !ausenciasChart.data.datasets[index].hidden : null;
                  
                  // Verificar quais datasets estão visíveis
                  const visibleDatasets = [];
                  for (let i = 0; i < ausenciasChart.data.datasets.length; i++) {
                    const meta = ausenciasChart.getDatasetMeta(i);
                    if (!meta.hidden) {
                      visibleDatasets.push(i);
                    }
                  }
                  
                  // Verificar quais meses têm dados em datasets visíveis
                  const monthsWithData = {};
                  originalData.labels.forEach((month, monthIndex) => {
                    monthsWithData[month] = false;
                    
                    visibleDatasets.forEach(datasetIndex => {
                      if (originalData.datasets[datasetIndex].data[monthIndex] > 0) {
                        monthsWithData[month] = true;
                      }
                    });
                  });
                  
                  // Filtrar os labels para incluir apenas meses com dados
                  const newLabels = [];
                  const monthIndices = [];
                  
                  originalData.labels.forEach((month, index) => {
                    if (monthsWithData[month]) {
                      newLabels.push(month);
                      monthIndices.push(index);
                    }
                  });
                  
                  // Atualizar os labels do gráfico
                  ausenciasChart.data.labels = newLabels;
                  
                  // Atualizar os dados de cada dataset para incluir apenas os meses com dados
                  ausenciasChart.data.datasets.forEach((dataset, datasetIndex) => {
                    const newData = [];
                    monthIndices.forEach(monthIndex => {
                      newData.push(originalData.datasets[datasetIndex].data[monthIndex]);
                    });
                    dataset.data = newData;
                  });
                  
                  // Atualizar o gráfico
                  ausenciasChart.update();
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    if (context.raw > 0) {
                      return `${context.dataset.label}: ${context.raw}`;
                    } else {
                      return null;
                    }
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                stacked: false,
                suggestedMax: Math.max(...data.ausencias, ...data.presencas, ...data.em_andamento, ...data.iniciado, ...data.suspenso, ...data.cancelado) * 1.2,
                grid: {
                  drawBorder: false,
                  display: true,
                  drawOnChartArea: true,
                  drawTicks: false,
                  borderDash: [5, 5]
                },
                ticks: {
                  display: true,
                  padding: 10,
                  color: '#b2b9bf',
                  stepSize: 1,
                  precision: 0,
                  callback: function(value) {
                    if (Math.floor(value) === value) {
                      return value;
                    }
                  },
                  font: {
                    size: 14,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 2
                  }
                }
              },
              x: {
                stacked: false,
                grid: {
                  drawBorder: false,
                  display: false,
                  drawOnChartArea: false,
                  drawTicks: false
                },
                ticks: {
                  display: true,
                  color: '#b2b9bf',
                  padding: 10,
                  maxRotation: 0,
                  minRotation: 0,
                  autoSkip: false,
                  font: {
                    size: 12,
                    family: 'Roboto',
                    style: 'normal',
                    lineHeight: 1.2
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Erro ao carregar dados de ausências:', error));

    // Gráfico de Alunos por Profissional
    fetch('/api/alunos-por-profissional/')
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById('alunos-profissional-chart').getContext('2d');
        
        // Usar a paleta de cores pastel para o gráfico de pizza
        const datasetData = data.datasets[0].data;
        
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Alunos',
              data: datasetData,
              backgroundColor: pastelColors.slice(0, datasetData.length),
              borderWidth: 0,
              hoverOffset: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                display: true,
                position: 'right',
                labels: {
                  font: {
                    family: 'Roboto',
                    size: 12
                  },
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    const label = context.chart.data.labels[context.dataIndex];
                    return `${label}: ${context.raw} alunos`;
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => console.error('Erro ao carregar dados de alunos por profissional:', error));

    // Gráfico de Especialização dos Profissionais
    fetch('/api/especializacao-profissionais/')
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById('especializacao-profissionais-chart').getContext('2d');
        
        // Aplicar cores pastel aos datasets
        if (data.datasets && data.datasets.length > 0) {
          data.datasets.forEach((dataset, index) => {
            const colorIndex = index % pastelColors.length;
            const color = pastelColors[colorIndex];
            
            dataset.backgroundColor = `${color}33`; // Adiciona transparência (20%)
            dataset.borderColor = color;
            dataset.pointBackgroundColor = color;
            dataset.pointBorderColor = '#fff';
            dataset.pointHoverBackgroundColor = '#fff';
            dataset.pointHoverBorderColor = color;
          });
        }
        
        new Chart(ctx, {
          type: 'radar',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
              line: {
                borderWidth: 2
              },
              point: {
                radius: 3,
                hitRadius: 10,
                hoverRadius: 5
              }
            },
            scales: {
              r: {
                angleLines: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                  beginAtZero: true,
                  stepSize: 1,
                  font: {
                    family: 'Roboto, Helvetica, Arial, sans-serif',
                    size: 11
                  }
                },
                pointLabels: {
                  font: {
                    family: 'Roboto, Helvetica, Arial, sans-serif',
                    size: 12,
                    weight: 'bold'
                  }
                }
              }
            },
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  font: {
                    family: 'Roboto, Helvetica, Arial, sans-serif',
                    size: 12
                  },
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.raw} alunos`;
                  }
                }
              }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados de especialização dos profissionais:', error);
      });

    // Tabela de Alerta de Alunos em Risco
    fetch('/api/alunos-em-risco/')
      .then(response => response.json())
      .then(data => {
        const tableBody = document.getElementById('alunos-em-risco-table');
        tableBody.innerHTML = '';
        
        if (data.alunos_risco && data.alunos_risco.length > 0) {
          // Agrupar alunos por ID
          const alunosAgrupados = {};
          
          // Primeiro passo: agrupar os dados por aluno
          data.alunos_risco.forEach(aluno => {
            if (!alunosAgrupados[aluno.id]) {
              alunosAgrupados[aluno.id] = {
                id: aluno.id,
                nome: aluno.nome,
                escola: aluno.escola,
                profissional_responsavel: aluno.profissional_responsavel,
                riscos: []
              };
            }
            
            // Adicionar este risco à lista de riscos do aluno
            alunosAgrupados[aluno.id].riscos.push({
              tipo: aluno.tipo_risco,
              detalhe: aluno.detalhe,
              severidade: aluno.severidade
            });
          });
          
          // Atualizar informações no footer
          const infoElement = document.getElementById('alunos-em-risco-info');
          if (data.total_alunos && data.total_alunos > data.exibindo) {
            infoElement.innerHTML = `Exibindo ${data.exibindo} de ${data.total_alunos} alunos em situação de risco`;
          } else {
            infoElement.innerHTML = 'Alunos que necessitam de atenção especial';
          }
          
          // Segundo passo: criar as linhas da tabela, uma para cada aluno
          Object.values(alunosAgrupados).forEach(aluno => {
            const row = document.createElement('tr');
            
            // Consolidar todos os tipos de risco em uma única string
            const tiposRisco = aluno.riscos.map(risco => {
              let severidadeClass = '';
              if (risco.severidade === 'alta') {
                severidadeClass = 'text-danger';
              } else if (risco.severidade === 'média') {
                severidadeClass = 'text-warning';
              } else {
                severidadeClass = 'text-info';
              }
              
              return `<span class="${severidadeClass}">${risco.tipo}</span>`;
            }).join('<br>');
            
            // Consolidar todos os detalhes em uma única string
            const detalhes = aluno.riscos.map(risco => {
              let severidadeClass = '';
              if (risco.severidade === 'alta') {
                severidadeClass = 'text-danger';
              } else if (risco.severidade === 'média') {
                severidadeClass = 'text-warning';
              } else {
                severidadeClass = 'text-info';
              }
              
              return `<span class="${severidadeClass}">${risco.detalhe}</span>`;
            }).join('<br>');
            
            row.innerHTML = `
              <td>
                <div class="d-flex px-2 py-1">
                  <div class="d-flex flex-column justify-content-center">
                    <h6 class="mb-0 text-sm">${aluno.nome}</h6>
                  </div>
                </div>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${aluno.escola}</p>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${aluno.profissional_responsavel || 'Não informado'}</p>
              </td>
              <td>
                <p class="text-xs font-weight-bold mb-0">${tiposRisco}</p>
              </td>
              <td>
                <p class="text-xs text-secondary mb-0">${detalhes}</p>
              </td>
            `;
            
            tableBody.appendChild(row);
          });
        } else {
          tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum aluno em situação de risco encontrado</td></tr>';
        }
      })
      .catch(error => {
        console.error('Erro ao carregar dados de alerta de alunos em risco:', error);
        document.getElementById('alunos-em-risco-table').innerHTML = 
          '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados</td></tr>';
      });

    // NOVO GRÁFICO: Neurodivergências por Escola
    fetch('/neurodivergentes/api/neurodivergencias-por-escola/')
      .then(response => response.json())
      .then(data => {
        // data.labels: nomes das escolas
        // data.datasets: lista de datasets (um para cada neurodivergência)
        const ctx = document.getElementById('chart-neurodivergencias-escola').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: data.datasets
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.raw}`;
                  }
                }
              }
            },
            scales: {
              x: { stacked: true, ticks: { display: false } },
              y: { stacked: true, beginAtZero: true }
            }
          }
        });
      })
      .catch(error => {
        console.error('Erro ao carregar dados do gráfico de neurodivergências por escola:', error);
      });

    // Carregar lista de profissionais para o dropdown
    fetch('/api/lista-profissionais/')
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('filtro-profissional');
        data.profissionais.forEach(prof => {
          const option = document.createElement('option');
          option.value = prof.id;
          option.textContent = prof.nome;
          select.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Erro ao carregar lista de profissionais:', error);
      });

    // Carregar meses do ano atual automaticamente
    function carregarMesesAtuais() {
      const selectMes = document.getElementById('filtro-mes');
      const anoAtual = new Date().getFullYear();
      const mesAtual = new Date().getMonth() + 1; // getMonth() retorna 0-11
      
      const nomesMeses = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      
      // Adicionar meses do ano atual
      for (let mes = 1; mes <= 12; mes++) {
        const option = document.createElement('option');
        const mesFormatado = mes.toString().padStart(2, '0');
        option.value = `${anoAtual}-${mesFormatado}`;
        option.textContent = `${nomesMeses[mes - 1]} ${anoAtual}`;
        
        // Marcar o mês atual como selecionado
        if (mes === mesAtual) {
          option.selected = true;
        }
        
        selectMes.appendChild(option);
      }
    }
    
    // Carregar meses
    carregarMesesAtuais();

    // Função para carregar dados do gráfico de atendimentos
    function carregarGraficoAtendimentos() {
      const profissionalId = document.getElementById('filtro-profissional').value;
      const periodo = document.getElementById('filtro-mes').value;
      
      let url = '/api/atendimentos-mensais-profissional/';
      const params = new URLSearchParams();
      
      if (profissionalId) params.append('profissional_id', profissionalId);
      if (periodo) params.append('periodo', periodo);
      
      if (params.toString()) {
        url += '?' + params.toString();
      }
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          const ctx = document.getElementById('chart-atendimentos-profissional').getContext('2d');
          
          // Destruir gráfico anterior se existir
          if (window.chartAtendimentosProfissional) {
            window.chartAtendimentosProfissional.destroy();
          }
          
          window.chartAtendimentosProfissional = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: data.datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                intersect: false
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                },
                x: {
                  ticks: {
                    maxRotation: 45,
                    minRotation: 0
                  }
                }
              },
              layout: {
                padding: {
                  top: 10,
                  bottom: 10
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Erro ao carregar dados do gráfico de atendimentos:', error);
        });
    }

    // Carregar gráfico inicial
    carregarGraficoAtendimentos();

    // Event listeners para os filtros
    document.getElementById('filtro-profissional').addEventListener('change', carregarGraficoAtendimentos);
    document.getElementById('filtro-mes').addEventListener('change', carregarGraficoAtendimentos);

  });
</script>
{% endblock %}
